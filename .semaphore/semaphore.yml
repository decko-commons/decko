version: v1.0
name: Decko Standard
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
global_job_config:
  env_vars:
    - name: BUNDLE_PATH
      value: "~/bundle/"
    - name: COVERAGE
      value: "false"
    - name: DECKO_REPO_PATH
      value: "~/decks"
  prologue:
    commands:
      - checkout # semaphore does git checkout and cds into decks
      - sem-version ruby 2.6.3 # because pry-stack_explorer doesn't work in 2.5
      - git submodule init
      - alias be='bundle exec'
      - git submodule status > substat.txt # needed for sem submodule caching
      - ruby .semaphore/submodules.rb restore # restore submodules from sem cache
      - cache restore bundle-gems-$(checksum Gemfile.lock) # restore gems from sem cache

blocks:
  - name: Cache dependencies
    task:
      jobs:
        - name: cache submodules and gems
          commands:
            # CACHE SUBMODULES
            # NOTE submodules themselves are restored in global_job config, but
            # .git/modules must be restored so that git knows everything is in order and
            # `git submodule update` only triggers cloning when needed
            - cache restore git-modules-$(checksum substat.txt)
            - git submodule update
            - ruby .semaphore/submodules.rb store
            - cache store git-modules-$(checksum substat.txt) .git/modules

            # CACHE GEMS
            - bundle install
            - cache store bundle-gems-$(checksum Gemfile.lock) ~/bundle

  - name: Smoke
    task:
      prologue:
        commands:
          - sem-service start mysql

      jobs:
        - name: New Shark and Monkey Decks
          commands:
            # NEW SHARK DECK
            - be decko new shark
            - cd shark
            - be decko seed

            - cd .. # note: faster than making a separate job.

            # NEW MONKEY DECK
            - be decko new monkey --monkey
            - cd monkey
            - be decko seed

  - name: Unit Tests
    task:
      env_vars:
        - name: RAILS_ENV
          value: "test"
      prologue:
        commands:
          - sem-service start mysql
      jobs:
        - name: RSpec
          commands:
            - be decko new platypus --platypus
            - cd platypus
            - be decko seed --test
            - be decko rspec

  - name: Integration Tests
    task:
      env_vars:
        - name: RAILS_ENV
          value: "test"
      prologue:
        commands:
          - sem-service start mysql
      jobs:
        - name: Cucumber
          commands:
            - be decko new platypus --platypus
            - cd platypus
            - be decko seed --test
            - be decko cucumber

  # - name: "Push Image"
  #   # dependencies: []
  #   task:
  #     jobs:
  #       - name: Push
  #         commands:
  #           - checkout
  #           - echo "make docker.push"
