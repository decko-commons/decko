version: v1.0
name: Decko Standard
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
global_job_config:
  env_vars:
    - name: BUNDLE_PATH
      value: "~/bundle/"
    - name: COVERAGE
      value: "false"
    - name: DECKO_REPO_PATH
      value: "~/decko"
  prologue:
    commands:
      - checkout # semaphore does git checkout and cds into decko
      - sem-version ruby 2.6.3 # because pry-stack_explorer doesn't work in 2.5
      - alias be='bundle exec'
      - git submodule init
      # - git submodule status > substat.txt # needed for sem submodule caching
      # - ruby .semaphore/submodules.rb restore # restore submodules from sem cache

blocks:
  - name: Smoke
    task:
      prologue:
        commands:
          - cache restore bundle-gems-baseline
          # occasionally clear: `cache delete bundle-gems-baseline`
          - cache restore bundle-gems-$(checksum Gemfile.lock)
          - bundle install
          - cache store bundle-gems-$(checksum Gemfile.lock) ~/bundle
          - cache store bundle-gems-baseline ~/bundle

          - sem-service start mysql
          - git submodule update card/db/seed

      jobs:
        - name: New Shark and Monkey Decks
          commands:
            # NEW SHARK DECK
            - be decko new shark
            - cd shark
            - be decko seed

            - cd .. # note: faster than making a separate job.

            # NEW MONKEY DECK
            - be decko new monkey --monkey
            - cd monkey
            - be decko seed

  - name: Unit Tests
    task:
      prologue:
        commands:
          - sem-service start mysql
          - git submodule update
          - cache restore bundle-gems-$(checksum Gemfile.lock)

      jobs:
        - name: RSpec
          commands:
            - be decko new platypus --platypus
            - cd platypus
            - be decko seed --test
            - be decko rspec

  - name: Integration Tests
    task:
      prologue:
        commands:
          - sem-service start mysql
          - git submodule update
          - cache restore bundle-gems-$(checksum Gemfile.lock)
          - be decko new platypus --platypus
          - cd platypus
          - be decko seed --test

      jobs:
        - name: Cypress
          commands:
            - RAILS_ENV=test CYPRESS_DEV=true bundle exec decko server -p 5002 -d
            - cd ~/decko/decko/spec
            - nvm use 10.10.0
            - yarn install
            - yarn run cypress run --record --key 15efb149-d03c-410b-bb10-6d3b1a82958e
        - name: Cucumber
          commands:
            - RAILS_ENV=cucumber bundle exec decko cucumber
